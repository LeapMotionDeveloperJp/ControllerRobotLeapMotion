<!DOCTYPE HTML>
<html>
<head>
    <title>ボクシング</title>
    <script type="text/javascript" src="../leapjs-widgets/javascripts/three.r67.js"></script>
    <script type="text/javascript" src="../leapjs-widgets/javascripts/lib/physi.js"></script>
    <script type="text/javascript" src="../leapjs-widgets/javascripts/leap-0.6.3.js"></script>
    <script type="text/javascript" src="../leapjs-widgets/javascripts/leap-plugins-0.1.6.min.js"></script>
    <script type="text/javascript" src="../leapjs-widgets/javascripts/leap.widgets.js"></script>
    <style type="text/css">#connect-leap {
            zoom: 0.4;
        }</style>
</head>
<body>
<script type="text/javascript">
    var initScene = function () {
        var rightGpio = "http://192.168.0.20:8000/GPIO/18/";
        var leftGpio = "http://192.168.0.20:8000/GPIO/24/";

        Physijs.scripts.worker = '../leapjs-widgets/javascripts/lib/physijs_worker.js';
        window.scene = new Physijs.Scene();
        window.scene.addEventListener('update', function () {
//            scene.simulate(undefined, 2);
        });
        window.scene.setGravity({x: 0, y: 0, z: 0});
        window.renderer = new THREE.WebGLRenderer({
            alpha: true
        });
        window.renderer.shadowMapEnabled = true;
        window.renderer.shadowMapType = THREE.BasicShadowMap;

        window.renderer.setClearColor(0x000000, 0);
        window.renderer.setSize(window.innerWidth, window.innerHeight);

        window.renderer.domElement.style.position = 'fixed';
        window.renderer.domElement.style.top = 0;
        window.renderer.domElement.style.left = 0;
        window.renderer.domElement.style.width = '100%';
        window.renderer.domElement.style.height = '100%';

        document.body.appendChild(window.renderer.domElement);

        window.widgets = new LeapWidgets(window.scene);
//        widgets.initLeapHand({sampleRecording: '../leapjs-widgets/recordings/buttons.lz'});
        widgets.initLeapHand({sampleRecording: ''});

        widgets.createLabel("ボクシングロボット", new THREE.Vector3(0, 120, -110), 16, 0xffffff);
//        var counterLabel = widgets.createLabel("0", new THREE.Vector3(0, 0, -110), 16, 0xffffff);
        var wall = widgets.createWall(new THREE.Vector3(0, 0, -200), new THREE.Vector3(500, 300, 100));
        var decreaseButton = widgets.createButton("左パンチ", new THREE.Vector3(-100, 0, -110), new THREE.Vector3(100, 70, 30));
        var increaseButton = widgets.createButton("右パンチ", new THREE.Vector3(100, 0, -110), new THREE.Vector3(100, 70, 30));
        var xmlHttpRequest = new XMLHttpRequest();
        decreaseButton.addEventListener('press', function (evt) {
//            counterLabel.setText(parseInt(counterLabel.getText()) - 1);
            leftHand();
        });
        increaseButton.addEventListener('press', function (evt) {
//            counterLabel.setText(parseInt(counterLabel.getText()) + 1);
            rightHand();
        });

        var spotLight = new THREE.SpotLight(0xffffff, 1);
        spotLight.shadowCameraVisible = true;
        spotLight.castShadow = true;
        spotLight.shadowMapWidth = 6048;
        spotLight.shadowMapHeight = 6048;
        spotLight.shadowCameraFar = 1000;
        spotLight.shadowDarkness = 0.5;
        spotLight.position.fromArray([wall.position.x, wall.position.y, wall.position.z + 1000]);
        spotLight.target.position.copy(wall.position);
        scene.add(spotLight);

        window.camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 10000);
        window.camera.position.fromArray([0, 0, 300]);
        window.camera.lookAt(new THREE.Vector3(0, decreaseButton.position.y, decreaseButton.position.z));

        window.addEventListener('resize', function () {
            camera.aspect = window.innerWidth / window.innerHeight;
//            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.render(scene, camera);
        }, false);
        scene.add(camera);

        function rightHand(){
            xmlHttpRequest.open("POST", rightGpio + "function/out");
            xmlHttpRequest.send();
            xmlHttpRequest.open("POST", rightGpio + "value/1");
            xmlHttpRequest.send();
            setTimeout(function(){
                xmlHttpRequest.open("POST", rightGpio + "value/0");
                xmlHttpRequest.send();
            },1000);
        }

        function leftHand(){
            xmlHttpRequest.open("POST", leftGpio + "function/out");
            xmlHttpRequest.send();
            xmlHttpRequest.open("POST", leftGpio + "value/1");
            xmlHttpRequest.send();
            setTimeout(function(){
                xmlHttpRequest.open("POST", leftGpio + "value/0");
                xmlHttpRequest.send();
            },1000);
        }
    };
    initScene();
</script>
</body>
</html>